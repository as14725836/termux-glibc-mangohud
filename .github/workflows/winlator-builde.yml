name: winlator MangoHud

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

permissions:
  contents: write

env:
  REPO_URL: https://github.com/flightlessmango/MangoHud.git
  LAST_COMMIT_FILE: last_mangohud_commit.txt

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      - name: Get last built commit
        id: get_last_commit
        run: |
          if [ -f "$LAST_COMMIT_FILE" ]; then
            echo "LAST_COMMIT=$(cat $LAST_COMMIT_FILE)" >> $GITHUB_ENV
          else
            echo "LAST_COMMIT=none" >> $GITHUB_ENV
          fi

      - name: Check upstream latest commit
        id: check_upstream
        run: |
          LATEST_COMMIT=$(git ls-remote $REPO_URL HEAD | awk '{print $1}')
          echo "LATEST_COMMIT=$LATEST_COMMIT" >> $GITHUB_ENV
          if [ "$LATEST_COMMIT" = "$LAST_COMMIT" ]; then
            echo "skip_build=true" >> $GITHUB_ENV
          else
            echo "skip_build=false" >> $GITHUB_ENV
          fi

      - name: Stop if no new commit
        if: env.skip_build == 'true'
        run: exit 0

      - name: Clone MangoHud source
        run: git clone --depth=1 $REPO_URL MangoHud

      - name: 获取源码版本号
        id: get_version
        run: |
          cd MangoHud
          if git describe --tags --abbrev=0 >/dev/null 2>&1; then
            VERSION=$(git describe --tags --abbrev=0)
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          AUTHOR=$(git log -1 --pretty=format:'%an')
          COMMIT=$(git rev-parse HEAD)
          DATE=$(date '+%Y-%m-%d %H:%M:%S UTC')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "AUTHOR=$AUTHOR" >> $GITHUB_ENV
          echo "COMMIT=$COMMIT" >> $GITHUB_ENV
          echo "BUILD_TIME=$DATE" >> $GITHUB_ENV

      - name: 安装基础依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential glslang-tools python3-pip git \
            pkg-config meson libdbus-1-dev libx11-dev \
            libxext-dev libxrandr-dev libxinerama-dev \
            libxdamage-dev libxfixes-dev libdrm-dev \
            libgl1-mesa-dev libwayland-dev libxkbcommon-dev patchelf

      - name: 升级 Meson 和 Ninja
        run: |
          pip install --upgrade pip
          pip install --upgrade meson ninja mako

      # ✅ 已移除补丁步骤
      - name: 跳过补丁
        run: echo "No patches applied (clean upstream build)."

      - name: 构建 MangoHud
        run: |
          cd MangoHud
          sudo mkdir -p /data/data/com.winlator/files/rootfs/usr
          sudo chmod -R 777 /data
          meson setup build \
            --prefix=/data/data/com.winlator/files/rootfs/usr \
            --libdir=lib \
            -Dbuildtype=release \
            -Dwith_x11=enabled \
            -Dwith_wayland=enabled \
            -Dwith_xnvctrl=disabled \
            -Dwith_dbus=enabled \
            -Dmangoplot=enabled \
            -Dmangoapp=false \
            -Dmangohudctl=false \
            -Dtests=disabled
          ninja -C build -j$(nproc)
          ninja -C build install

      # ✅ 修复：解释器路径使用 Winlator glibc 正确位置
      - name: 修补 ELF 可执行文件解释器路径
        run: |
          ROOT=/data/data/com.winlator/files/rootfs/usr
          INTERP="/data/data/com.winlator/files/rootfs/usr/lib/ld-linux-aarch64.so.1"
          for f in $(find "$ROOT" -type f -exec file {} \; | grep ELF | cut -d: -f1); do
            patchelf --set-interpreter "$INTERP" "$f" 2>/dev/null || true
          done

      - name: 打包构建产物
        run: |
          ROOT=/data/data/com.winlator/files/rootfs/usr
          TAR_NAME="winlator-mangohud-${{ env.VERSION }}-aarch64.tar.gz"
          cd /data/data/com.winlator/files/rootfs
          tar -czvf /home/runner/$TAR_NAME usr
          echo "TAR_NAME=$TAR_NAME" >> $GITHUB_ENV

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TAR_NAME }}
          path: /home/runner/${{ env.TAR_NAME }}

      - name: 发布 Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: MangoHud ${{ env.VERSION }} (aarch64, Winlator)
          files: /home/runner/${{ env.TAR_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Save last commit hash
        run: echo "$LATEST_COMMIT" > $LAST_COMMIT_FILE

      - name: Upload commit record
        uses: actions/upload-artifact@v4
        with:
          name: last-mangohud-commit
          path: ${{ env.LAST_COMMIT_FILE }}
