name: Wine 无bootBuilder

on:
  schedule:
    # Wine 64位构建 - 每月1号和15号
    - cron: '0 0 1,15 * *'
    # Wine WOW64构建 - 每月5号和20号
    - cron: '0 2 5,20 * *'
  workflow_dispatch:
    inputs:
      build_type:
        description: '选择构建类型'
        required: true
        default: 'wine-64bit'
        type: choice
        options:
        - wine-64bit
        - wine-wow64
      wine_branch:
        description: 'Wine 分支'
        required: false
        default: 'staging'
        type: choice
        options:
        - vanilla
        - staging
        - staging-tkg
        - staging-tkg-fsync
      wine_version:
        description: 'Wine 版本'
        required: false
        default: 'latest'
        type: string

env:
  USE_CCACHE: true
  BUILD_DIR: /tmp/build_wine

permissions:
  contents: write  # 允许 GITHUB_TOKEN 创建 Release

jobs:
  build-wine-64bit:
    runs-on: ubuntu-24.04
    if: github.event.inputs.build_type == 'wine-64bit' || (github.event_name == 'schedule' && github.event.schedule == '0 0 1,15 * *')
    timeout-minutes: 180
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 安装构建依赖
        run: |
          sudo apt update
          sudo apt --fix-broken install -y
          
          BASE_DEPS="\
            debootstrap \
            perl \
            git \
            wget \
            xz-utils \
            bubblewrap \
            autoconf \
            flex \
            bison \
            gcc-multilib \
            g++-multilib \
            libx11-dev \
            libxext-dev \
            libxi-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libxfixes-dev \
            libxxf86vm-dev \
            libxrender-dev \
            libxinerama-dev \
            libgl-dev \
            libsdl2-dev \
            libglu-dev \
            libosmesa6-dev \
            libfreetype6-dev \
            libfontconfig1-dev \
            libpcap-dev \
            libdbus-1-dev \
            libssl-dev \
            libasound2-dev \
            libpulse-dev \
            libudev-dev \
            libcups2-dev \
            libjpeg-dev \
            libpng-dev \
            libtiff-dev \
            libxml2-dev \
            libvulkan-dev \
            vulkan-tools \
            libvulkan1 \
            mesa-vulkan-drivers \
            mingw-w64 \
            gettext \
            libgettextpo-dev \
            locales \
            language-pack-zh-hans"
          
          sudo apt install -y $BASE_DEPS
          
      - name: 安装多媒体和音频依赖
        run: |
          sudo apt update
          sudo apt install -y \
            libunwind-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-* \
            libmpg123-dev \
            libopenal-dev
              
      - name: 设置中文语言环境
        run: |
          sudo locale-gen zh_CN.UTF-8
          sudo update-locale LANG=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          
      - name: 构建 Wine 64位版本
        run: |
          set -e
          
          echo "开始构建 Wine 64位版本..."
          echo "分支: ${{ github.event.inputs.wine_branch || 'staging' }}"
          echo "版本: ${{ github.event.inputs.wine_version || 'latest' }}"
          
          export LANG=zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANGUAGE=zh_CN:zh:en_US:en
          
          rm -rf $BUILD_DIR/wine-64bit
          mkdir -p $BUILD_DIR/wine-64bit
          cd $BUILD_DIR/wine-64bit
          
          git clone https://gitlab.winehq.org/wine/wine.git
          cd wine
          
          WINE_VERSION="${{ github.event.inputs.wine_version || 'latest' }}"
          WINE_BRANCH="${{ github.event.inputs.wine_branch || 'staging' }}"
          
          git config advice.detachedHead false
          
          if [ "$WINE_VERSION" != "latest" ]; then
            if git checkout "wine-$WINE_VERSION" 2>/dev/null || git checkout "$WINE_VERSION" 2>/dev/null; then
              echo "成功切换到版本 $WINE_VERSION"
            else
              echo "版本 $WINE_VERSION 不存在，使用最新版本"
            fi
          fi
          
          if [ "$WINE_BRANCH" = "staging" ]; then
            echo "应用 Wine-Staging 补丁..."
            WINE_VERSION_ACTUAL=$(git describe --tags --abbrev=0 2>/dev/null || echo "$WINE_VERSION")
            PURE_VERSION=$(echo "$WINE_VERSION_ACTUAL" | sed 's/^wine-//')
            STAGING_VERSION="v${PURE_VERSION}"
            
            echo "尝试下载 staging 补丁版本: $STAGING_VERSION"
            wget -O "wine-staging-${PURE_VERSION}.tar.gz" "https://github.com/wine-staging/wine-staging/archive/refs/tags/${STAGING_VERSION}.tar.gz" || \
            wget -O "wine-staging-${PURE_VERSION}.tar.gz" "https://github.com/wine-staging/wine-staging/archive/refs/tags/v${PURE_VERSION}.tar.gz"
            
            if [ -f "wine-staging-${PURE_VERSION}.tar.gz" ]; then
              tar -xzf "wine-staging-${PURE_VERSION}.tar.gz"
              
              if [ -d "wine-staging-${PURE_VERSION}" ]; then
                cd "wine-staging-${PURE_VERSION}/staging"
                chmod +x patchinstall.py
                ./patchinstall.py --all --destdir=../../
                cd "../.."
              elif [ -d "wine-staging-${STAGING_VERSION}" ]; then
                cd "wine-staging-${STAGING_VERSION}/staging"
                chmod +x patchinstall.py
                ./patchinstall.py --all --destdir=../../
                cd "../.."
              else
                echo "警告: 未找到预期的 staging 目录结构"
              fi
            else
              echo "警告: 无法下载 staging 补丁，继续构建无补丁版本"
            fi
          fi
          
          echo "修复 Termux 路径问题..."
          find . -type f \( -name "*.c" -o -name "*.h" -o -name "*.in" -o -name "*.spec" \) -exec grep -l "/tmp" {} \; | xargs sed -i 's|/tmp/|/data/data/com.termux/files/usr/tmp/|g'
          find server -type f \( -name "*.c" -o -name "*.h" \) -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
          find . -name "file.c" -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
          find . -name "loader.c" -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
          find . -name "server.c" -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
          
          echo "路径修复完成"
          
          VERSION_WINE=$(git describe --tags --abbrev=0 2>/dev/null || echo "$WINE_VERSION")
          COMMIT_HASH=$(git rev-parse --short HEAD)
          BUILD_VERSION="${VERSION_WINE}-${COMMIT_HASH}"
          echo "BUILD_VERSION=$BUILD_VERSION" >> $GITHUB_ENV
          echo "BUILD_NAME=wine-${BUILD_VERSION}-64bit-$WINE_BRANCH" >> $GITHUB_ENV
          
          echo "生成 configure 脚本..."
          #./autogen.sh
          
          mkdir -p build-64bit
          cd build-64bit
          
          export CROSSCC="x86_64-w64-mingw32-gcc"
          export CROSSCXX="x86_64-w64-mingw32-g++"
          export CFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"
          export CXXFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"
          export CROSSCFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"
          export CROSSCXXFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"
          
          ../configure \
            --enable-win64 \
            --prefix=/tmp/wine-install-64bit \
            --with-x \
            --with-vulkan \
            --with-alsa \
            --with-pulse \
            --with-freetype \
            --with-fontconfig \
            --with-gstreamer \
            --with-gettext \
            --with-sdl \
            --enable-nls \
            --disable-winemenubuilder \
            --disable-win16 \
            --disable-tests \
            --without-ldap \
            --without-oss \
            --without-cups \
            --without-dbus \
            --without-coreaudio \
            --without-gphoto \
            --without-osmesa \
            --without-sane \
            --without-pcap \
            --without-pcsclite \
            --without-udev \
            --without-unwind \
            --without-usb \
            --without-v4l2 \
            --without-wayland
            
          ./autogen.sh
            
          echo "开始构建支持 Vulkan 和完整 GStreamer 的 64位 Wine..."
          make -j$(nproc)
          make install
          
          cd ../..
          
      - name: 准备打包
        run: |
          PACKAGE_NAME="${{ env.BUILD_NAME }}"
          mkdir -p wine-package/$PACKAGE_NAME
          
          echo "复制 Wine 文件到 $PACKAGE_NAME..."
          cp -r /tmp/wine-install-64bit/* wine-package/$PACKAGE_NAME/
          
      - name: 创建打包文件
        run: |
          PACKAGE_NAME="${{ env.BUILD_NAME }}"
          
          echo "最终文件结构:"
          find wine-package -type f | sort | head -20
          
          tar -cJf $PACKAGE_NAME.tar.xz -C wine-package $PACKAGE_NAME
          
          echo "打包完成:"
          ls -lh *.tar.xz
          
      - name: Generate checksums
        run: |
          cd $GITHUB_WORKSPACE
          sha256sum *.tar.xz > checksums.txt
          cat checksums.txt
          
      - name: Upload Wine 64bit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Wine-${{ github.event.inputs.wine_branch || 'staging' }}-${{ github.event.inputs.wine_version || 'latest' }}-64bit
          path: |
            ${{ github.workspace }}/*.tar.xz
            ${{ github.workspace }}/checksums.txt
          retention-days: 30

      - name: 发布 Wine 到 GitHub Release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'wine-64bit'
        with:
          tag_name: wine-${{ github.event.inputs.wine_branch || 'staging' }}-${{ github.event.inputs.wine_version || 'latest' }}-64bit
          name: Wine ${{ github.event.inputs.wine_branch || 'staging' }} ${{ github.event.inputs.wine_version || 'latest' }} (64bit with Vulkan & GStreamer for Termux)
          body: |
            # Wine ${{ github.event.inputs.wine_branch || 'staging' }} ${{ github.event.inputs.wine_version || 'latest' }} - 64bit with Vulkan & GStreamer for Termux
            
            ## 版本信息
            - **Wine 分支**: ${{ github.event.inputs.wine_branch || 'staging' }}
            - **Wine 版本**: ${{ github.event.inputs.wine_version || 'latest' }}
            - **架构**: 64位 (支持64位Windows应用程序)
            - **平台**: Termux (Android)
            - **图形 API**: Vulkan 支持已启用
            - **多媒体**: 完整 GStreamer 支持
            - **源码**: 官方 Wine 源码 (gitlab.winehq.org)
            
            ## 特性
            ✓ 64位架构
            ✓ 支持64位Windows应用程序
            ✓ Vulkan 图形 API 支持
            ✓ 完整的 GStreamer 支持
            ✓ 中文环境支持
            ✓ 官方 Wine 源码构建
            
            ## 安装说明
            解压后，将 `${{ env.BUILD_NAME }}` 文件夹放置在 Termux 的合适位置，并设置环境变量。
            
            ## 构建信息
            - 构建时间: ${{ github.event.head_commit.timestamp }}
            - 提交: ${{ github.sha }}
            - 工作流: ${{ github.workflow }}
          files: |
            ${{ github.workspace }}/${{ env.BUILD_NAME }}.tar.xz
            ${{ github.workspace }}/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
