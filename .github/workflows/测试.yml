name: Build Hangover-Wine

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Build in Docker
      run: |
        # 直接运行 Termux Docker 容器
        docker run --rm \
          --user root \
          -v $PWD:/workspace \
          -w /workspace \
          termux/termux-docker:aarch64 \
          /bin/bash -c "
            # 安装基础工具
            apt update && apt install -y termux-keyring termux-tools git sed
            
            # 克隆 termux-packages
            git clone https://github.com/termux/termux-packages
            cd termux-packages
            
            # 修改 hangover 配置，禁用 GStreamer
            sed -i 's/--with-gstreamer/--without-gstreamer/' packages/hangover-wine/build.sh
            
            # 显示修改后的配置（调试用）
            grep -A5 'TERMUX_PKG_EXTRA_CONFIGURE_ARGS' packages/hangover-wine/build.sh
            
            # 构建包
            ./build-package.sh -a aarch64 -I hangover-wine
          "
    
    - name: Upload .deb package
      uses: actions/upload-artifact@v4
      with:
        name: hangover-wine-aarch64
        path: |
          termux-packages/debs/*hangover*.deb
        retention-days: 30
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: termux-packages/debs/*.deb
