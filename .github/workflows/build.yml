name: Build MangoHud (aarch64, Termux glibc)

on:
  workflow_dispatch:
  pull_request:

permissions:
  contents: write  # å…è®¸ GITHUB_TOKEN åˆ›å»º Release

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: æ£€å‡ºæºç 
        uses: actions/checkout@v4

      - name: è·å–æºç ç‰ˆæœ¬å·
        id: get_version
        run: |
          cd MangoHud || git clone https://github.com/flightlessmango/MangoHud.git && cd MangoHud
          if git describe --tags --abbrev=0 >/dev/null 2>&1; then
            VERSION=$(git describe --tags --abbrev=0)
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          echo "Detected version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential glslang-tools python3-pip git \
            pkg-config meson libdbus-1-dev libx11-dev \
            libxext-dev libxrandr-dev libxinerama-dev \
            libxdamage-dev libxfixes-dev libdrm-dev \
            libgl1-mesa-dev libwayland-dev libxkbcommon-dev patchelf
          sudo apt show libgl1-mesa-dev libx11-dev libxext-dev libdrm-dev

      - name: å‡çº§ Meson å’Œ Ninja åˆ°æœ€æ–°ç‰ˆæœ¬
        run: |
          pip install --upgrade pip
          pip install --upgrade meson ninja mako
          meson --version
          ninja --version

      - name: åº”ç”¨ CPU é¢‘ç‡ fallback è¡¥ä¸
        run: |
          cd MangoHud
          SRC_FILE="src/sysinfo/linux.cpp"
          if [ -f "$SRC_FILE" ]; then
            echo "ğŸ”§ ä¿®æ”¹ $SRC_FILE ä»¥å¢åŠ  /proc/cpuinfo fallback..."
            sed -i '/int get_cpu_freq(int core)/,/return freq;/c\
int get_cpu_freq(int core) {\
    int freq = 0;\
    std::ifstream file("/sys/devices/system/cpu/cpu" + std::to_string(core) + "/cpufreq/scaling_cur_freq");\
    if(file.is_open()) { file >> freq; freq /= 1000; return freq; }\
    std::ifstream cpuinfo("/proc/cpuinfo");\
    if(cpuinfo.is_open()) {\
        std::string line;\
        int core_index=-1;\
        while(std::getline(cpuinfo, line)) {\
            if(line.find("processor") != std::string::npos) core_index++;\
            if(core_index==core && line.find("cpu MHz") != std::string::npos) {\
                std::istringstream iss(line.substr(line.find(":")+1));\
                iss >> freq;\
                return freq;\
            }\
        }\
    }\
    return 0;\
}' "$SRC_FILE"
          else
            echo "âš ï¸ æ‰¾ä¸åˆ° $SRC_FILE"
          fi

      - name: æ„å»º MangoHudï¼ˆTermux glibc ç‰ˆæœ¬ï¼‰
        run: |
          cd MangoHud
          sudo mkdir -p /data/data/com.termux/files/usr/glibc
          sudo chmod -R 777 /data
          meson setup build \
            --prefix=/data/data/com.termux/files/usr/glibc \
            --libdir=lib \
            -Dbuildtype=release \
            -Dglibcxx_asserts=false \
            -Duse_system_spdlog=disabled \
            -Dinclude_doc=false \
            -Dwith_nvml=disabled \
            -Dwith_xnvctrl=disabled \
            -Dwith_x11=enabled \
            -Dwith_wayland=enabled \
            -Dwith_dbus=enabled \
            -Dloglevel=info \
            -Dmangoapp=false \
            -Dmangohudctl=false \
            -Dtests=disabled \
            -Dmangoplot=enabled \
            -Ddynamic_string_tokens=true \
            -Dwith_fex=false
          ninja -C build -j$(nproc)
          ninja -C build install

      - name: ä¿®æ­£ MangoHud å®‰è£…è·¯å¾„ä¸­çš„ \$LIB
        run: |
          ROOT=/data/data/com.termux/files/usr/glibc
          if [ -f "$ROOT/bin/mangohud" ]; then
            echo "ğŸ”§ ä¿®æ­£ $ROOT/bin/mangohud ä¸­çš„è·¯å¾„..."
            sed -i 's|/\\$LIB|/lib|g' "$ROOT/bin/mangohud"
            grep MANGOHUD_LIB_NAME "$ROOT/bin/mangohud" || true
          else
            echo "âš ï¸ æ‰¾ä¸åˆ° $ROOT/bin/mangohud æ–‡ä»¶"
          fi

      - name: å¯¹ glibc ä¸‹çš„ ELF å¯æ‰§è¡Œæ–‡ä»¶åº”ç”¨ patchelf
        run: |
          INTERP=/data/data/com.termux/files/usr/glibc/lib/ld-linux-aarch64.so.1
          ROOT=/data/data/com.termux/files/usr/glibc
          echo "âœ… ä¿®è¡¥ bin ç›®å½•..."
          if [ -d "$ROOT/bin" ]; then
            for f in "$ROOT/bin/"*; do
              if file "$f" | grep -q 'ELF.*executable'; then
                echo "Patching: $f"
                patchelf --set-interpreter "$INTERP" "$f" || true
              fi
            done
          fi
          echo "âœ… ä¿®è¡¥ lib ç›®å½•..."
          if [ -d "$ROOT/lib" ]; then
            for f in "$ROOT/lib/"*; do
              if file "$f" | grep -q 'ELF'; then
                echo "Patching: $f"
                patchelf --set-interpreter "$INTERP" "$f" || true
              fi
            done
          fi

      - name: æ‰“åŒ…æ•´ä¸ª glibc æ–‡ä»¶å¤¹ï¼ˆå¼€å‘ç‰ˆæœ¬ï¼‰
        run: |
          cd /data/data/com.termux/files/usr
          TAR_NAME="termux-glibc-mangohud-${{ env.VERSION }}.tar.gz"
          tar -czvf /home/runner/${TAR_NAME} glibc
          echo "TAR_NAME=${TAR_NAME}" >> $GITHUB_ENV

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TAR_NAME }}
          path: /home/runner/${{ env.TAR_NAME }}

      - name: å‘å¸ƒåˆ° GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: MangoHud ${{ env.VERSION }} (aarch64, Termux glibc)
          files: /home/runner/${{ env.TAR_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è¾“å‡ºå®Œæˆä¿¡æ¯
        run: |
          echo "âœ… MangoHud æ„å»ºå®Œæˆ"
          echo "ğŸ“¦ è¾“å‡ºæ–‡ä»¶: ${{ env.TAR_NAME }}"
          echo "ğŸ”– ç‰ˆæœ¬å·: ${{ env.VERSION }}"
